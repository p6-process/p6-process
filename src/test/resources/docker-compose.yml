version: "2"

services:

  p6-artemis:
    container_name: p6-artemis
    image: vromero/activemq-artemis:2.11.0-alpine
    environment:
      ARTEMIS_USERNAME: "admin"
      ARTEMIS_PASSWORD: "admin"
      DISABLE_SECURITY: "true"
      ARTEMIS_PERF_JOURNAL: "NEVER"
      CRITICAL_ANALYZER: "false"
      ENABLE_JMX: "false"
      ENABLE_JMX_EXPORTER: "false"
    volumes:
      - ./broker-00.xml:/var/lib/artemis/etc-override/broker-00.xml
    labels:
      - "test.priority=1"
      - "test.Wait.forLogMessage.regex=.*AMQ241004: Artemis Console available at.*"
      - "test.Wait.forLogMessage.times=1"
      - "test.log=true"
      - "test.property.quarkus.artemis.username=admin"
      - "test.property.quarkus.artemis.password=admin"
      - "test.property.quarkus.artemis.url=tcp://$${host:p6-artemis}:$${port:p6-artemis:61616}"
    ports:
      - "61616:61616"
    networks:
      - test

  p6-db:
    container_name: p6-db
    image: cockroachdb/cockroach:v19.2.6
    command: start-single-node --insecure --listen-addr=0.0.0.0
    ports:
      - "26257:26257"
    labels:
      - "test.priority=1"
      - "test.Wait.forLogMessage.regex=.*nodeID.*"
      - "test.Wait.forLogMessage.times=1"
      - "test.log=true"
      - "test.property.quarkus.datasource.jdbc.url=jdbc:postgresql://$${host:p6-db}:$${port:p6-db:26257}/postgres?sslmode=disable"
    networks:
      - test

  p6-process:
    container_name: p6-process
    image: quay.io/p6-process/p6-process:latest
    ports:
      - "8080:8080"
    labels:
      - "test.unit=false"
      - "test.priority=101"
      - "test.image.pull=DEFAULT"
      - "test.env.QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://p6-db:26257?sslmode=disable"
      - "test.env.ARTEMIS_URL=tcp://p6-artemis:61616"
    volumes:
      - ./p6:/work/p6
    networks:
      - test

networks:
  test: